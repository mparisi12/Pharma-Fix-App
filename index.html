<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Troubleshooting Pharma</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f0f2f5; color: #333; }
        h1 { text-align: center; color: #2c3e50; }
        
        .search-container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 15px;}
        
        /* Stili bottoni */
        .btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; width: 100%; text-align: center; }
        .btn-cerca { background-color: #3498db; color: white; }
        .btn-reset { background-color: #95a5a6; color: white; margin-top: 10px; }
        .btn-nuovo { background-color: #27ae60; color: white; margin-bottom: 20px; }
        .btn:hover { opacity: 0.9; }

        /* Stili Form Inserimento (nascosto all'inizio) */
        #formInserimento { display: none; background: #e9f7ef; padding: 20px; border: 2px solid #27ae60; border-radius: 12px; margin-bottom: 20px; }
        textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: sans-serif; resize: vertical; box-sizing: border-box; }
        
        select, input { padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; width: 100%; box-sizing: border-box; }
        
        .card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 6px solid #e74c3c; }
        .macchina-tag { display: inline-block; background: #ecf0f1; color: #7f8c8d; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; margin-bottom: 10px; font-weight: bold; }
        .soluzione-box { background-color: #e8f8f5; padding: 15px; border-radius: 6px; border: 1px solid #d1f2eb; margin-top: 10px; }
    </style>
</head>
<body>

    <h1>üè• Pharma-Fix Troubleshooting</h1>
    
    <button class="btn btn-nuovo" onclick="mostraForm()">‚ûï AGGIUNGI NUOVO GUASTO</button>

    <div id="formInserimento">
        <h3>Nuova Segnalazione</h3>
        <label>Macchina:</label>
        <select id="nuovaMacchina" style="margin-bottom: 10px;">
            <option value="">-- Seleziona --</option>
        </select>

        <label>Problema riscontrato:</label>
        <textarea id="nuovoProblema" rows="2" placeholder="Descrivi il guasto..."></textarea>
        
        <label style="margin-top:10px; display:block">Azione Risolutiva:</label>
        <textarea id="nuovaSoluzione" rows="3" placeholder="Come hai risolto?"></textarea>

        <div style="margin-top: 15px; display: flex; gap: 10px;">
            <button class="btn btn-cerca" style="background-color: #27ae60;" onclick="salvaGuasto()">SALVA DATI</button>
            <button class="btn btn-reset" onclick="nascondiForm()">ANNULLA</button>
        </div>
        <p id="statoSalvataggio" style="text-align: center; font-weight: bold;"></p>
    </div>

    <div class="search-container">
        <label><strong>1. Seleziona Macchina:</strong></label>
        <select id="selectMacchina">
            <option value="">Caricamento...</option>
        </select>

        <label><strong>2. Cerca Guasto:</strong></label>
        <input type="text" id="inputUtente" placeholder="Es. 'blocco', 'rumore'">
        
        <button class="btn btn-cerca" onclick="cercaSoluzione()">CERCA</button>
        <button class="btn btn-reset" onclick="resetFiltri()">PULISCI RICERCA</button>
    </div>

    <div id="risultato" style="margin-top: 30px;"></div>

    <script>
        // *** INSERISCI QUI IL TUO LINK ***
        const URL_GOOGLE_SCRIPT = 'https://script.google.com/macros/s/AKfycbzXyDbFwlMA6X_wJ-vmFoZHDDJzUROg67UpieZY2pEgnVR4PrSbL1Tsa2aUUycKPm0a/exec'; 

        let elencoGuasti = [];
        let listaNomiMacchine = [];

        window.onload = async function() {
            caricaDati();
        };

        async function caricaDati() {
            const select = document.getElementById('selectMacchina');
            const selectNuovo = document.getElementById('nuovaMacchina');
            
            try {
                const risposta = await fetch(URL_GOOGLE_SCRIPT);
                const pacchettoDati = await risposta.json();

                elencoGuasti = pacchettoDati.guasti;
                listaNomiMacchine = pacchettoDati.macchine;

                // Popola entrambi i menu a tendina (Ricerca e Inserimento)
                let opzioni = '<option value="">-- Seleziona Macchina --</option>';
                listaNomiMacchine.forEach(nome => {
                    opzioni += `<option value="${nome}">${nome}</option>`;
                });
                
                select.innerHTML = opzioni;
                selectNuovo.innerHTML = opzioni;

            } catch (errore) {
                console.error(errore);
                select.innerHTML = '<option>Errore connessione</option>';
            }
        }

        function mostraForm() {
            document.getElementById('formInserimento').style.display = 'block';
            window.scrollTo(0,0);
        }

        function nascondiForm() {
            document.getElementById('formInserimento').style.display = 'none';
        }

        async function salvaGuasto() {
            const macchina = document.getElementById('nuovaMacchina').value;
            const problema = document.getElementById('nuovoProblema').value;
            const soluzione = document.getElementById('nuovaSoluzione').value;
            const statusBox = document.getElementById('statoSalvataggio');

            if (!macchina || !problema || !soluzione) {
                alert("Compila tutti i campi!");
                return;
            }

            statusBox.innerHTML = "‚è≥ Salvataggio in corso...";
            statusBox.style.color = "blue";

            // Creiamo il pacchetto da spedire
            const datiDaSpedire = {
                macchina: macchina,
                problema: problema,
                soluzione: soluzione
            };

            try {
                // SPEDIZIONE CON METODO POST
                // Nota: usiamo text/plain per evitare problemi di sicurezza CORS con Google
                await fetch(URL_GOOGLE_SCRIPT, {
                    method: 'POST',
                    body: JSON.stringify(datiDaSpedire)
                });

                statusBox.innerHTML = "‚úÖ Salvato con successo! Ricarico...";
                statusBox.style.color = "green";
                
                // Dopo 1.5 secondi ricarichiamo i dati per vedere il nuovo guasto
                setTimeout(() => {
                    nascondiForm();
                    statusBox.innerHTML = "";
                    // Puliamo i campi
                    document.getElementById('nuovoProblema').value = "";
                    document.getElementById('nuovaSoluzione').value = "";
                    caricaDati(); // Ricarica il database senza aggiornare la pagina
                }, 1500);

            } catch (errore) {
                console.error(errore);
                statusBox.innerHTML = "‚ö†Ô∏è Errore nel salvataggio.";
                statusBox.style.color = "red";
            }
        }

        function cercaSoluzione() {
            const macchinaScelta = document.getElementById('selectMacchina').value;
            const testoUtente = document.getElementById('inputUtente').value.toLowerCase();
            const divRisultato = document.getElementById('risultato');
            
            divRisultato.innerHTML = "";
            let count = 0;

            const guastiDellaMacchina = elencoGuasti.filter(g => g.macchina === macchinaScelta || macchinaScelta === "");

            if (macchinaScelta !== "" && guastiDellaMacchina.length === 0) {
                 divRisultato.innerHTML = `<p style="text-align:center">‚úÖ Nessun guasto storico per ${macchinaScelta}.</p>`;
                 return;
            }

            elencoGuasti.forEach(riga => {
                const corrispondeMacchina = macchinaScelta === "" || riga.macchina === macchinaScelta;
                const corrispondeTesto = testoUtente === "" || (riga.problema + " " + riga.soluzione).toLowerCase().includes(testoUtente);

                if (corrispondeMacchina && corrispondeTesto) {
                    count++;
                    divRisultato.innerHTML += `
                        <div class="card">
                            <span class="macchina-tag">MACCHINA: ${riga.macchina}</span>
                            <h3>GUASTO: ${riga.problema}</h3>
                            <div class="soluzione-box">
                                <strong>SOLUZIONE:</strong><br>
                                ${riga.soluzione}
                            </div>
                        </div>
                    `;
                }
            });

            if (count === 0 && (macchinaScelta || testoUtente)) {
                divRisultato.innerHTML = "<p style='text-align:center'>‚ùå Nessun risultato.</p>";
            }
        }

        function resetFiltri() {
            document.getElementById('selectMacchina').value = "";
            document.getElementById('inputUtente').value = "";
            document.getElementById('risultato').innerHTML = "";
        }
    </script>

</body>
</html>